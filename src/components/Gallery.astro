---
import { Image } from 'astro:assets';
import Layout from './Layout.astro';
import 'photoswipe/style.css';

export interface GalleryImage {
	src: string;
	width: number;
	height: number;
}

interface Props {
	images: GalleryImage[];
	title?: string;
	subtitle?: string;
	description?: string;
}
const { images, title = 'Gallery', subtitle, description } = Astro.props;

interface TapeConfig {
	tapeV: number;
	wearV: number;
	tapes: number;
	tape1Pos: string;
	tape2Style: string;
	tape3Hide: string;
	loading: 'eager' | 'lazy';
}
const tapeConfigs: TapeConfig[] = images.map((_, i) => {
	const n = i % 20;
	const tapes = n === 0 ? 1 : n <= 4 ? 2 : n <= 9 ? 3 : 4;
	const tape1Pos = (i % 2 === 0) ? 'tl' : 'tr';
	const tape2Style = (n <= 2) ? 'top' : (i % 2 === 0) ? 'diag-tlbr' : 'diag-trbl';
	const tape3Hide = (i % 4 === 0) ? 'br' : (i % 4 === 1) ? 'bl' : (i % 4 === 2) ? 'tr' : 'tl';
	return {
		tapeV: i % 6,
		wearV: i % 5,
		tapes,
		tape1Pos,
		tape2Style,
		tape3Hide,
		loading: i < 8 ? 'eager' : 'lazy',
	};
});
---

<Layout title={title} description={description ?? 'A photo gallery'}>
<main class="relative min-h-screen">
	<header class="nostalgia-header">
		<div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 pt-10 pb-8 sm:pt-14 sm:pb-10 text-center">
			{subtitle && (
				<p class="font-outfit text-xs sm:text-sm uppercase tracking-[0.35em] text-[var(--nostalgia-accent)] font-medium mb-2">
					{subtitle}
				</p>
			)}
			<h1 class="font-instrument text-4xl sm:text-5xl lg:text-6xl tracking-tight text-[var(--nostalgia-ink)]">
				{title}
			</h1>
			{description && (
				<p class="font-cormorant text-lg sm:text-xl text-[var(--nostalgia-sepia)] mt-4 max-w-2xl mx-auto leading-relaxed italic">
					{description}
				</p>
			)}
			{images.length > 0 && (
				<p class="font-outfit text-sm text-[var(--nostalgia-sepia)]/80 mt-3">
					{images.length} photo{images.length === 1 ? '' : 's'}
				</p>
			)}
			<div class="nostalgia-divider mt-6 mx-auto" aria-hidden="true"></div>
		</div>
	</header>

	<div class="concrete-wall mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 sm:py-12 pb-16 sm:pb-24">
		{images.length > 0 ? (
			<div
				id="gallery"
				class="gallery masonry-columns nostalgia-gallery"
				role="list"
			>
				{images.map((img, i) => {
					const c = tapeConfigs[i];
					return (
					<a
						href={img.src}
						data-pswp-width={img.width}
						data-pswp-height={img.height}
						class="gallery-item group block mb-8 sm:mb-10 break-inside-avoid"
						role="listitem"
					>
						<div
							class="nostalgia-card photo-on-wall overflow-visible transition-all duration-500 ease-out group-hover:-translate-y-0.5"
							data-wear={c.wearV}
							data-tapes={c.tapes}
							data-tape-1={c.tapes === 1 ? c.tape1Pos : undefined}
							data-tapes-2={c.tapes === 2 ? c.tape2Style : undefined}
							data-tapes-3={c.tapes === 3 ? c.tape3Hide : undefined}
						>
							<span class="tape tape-tl" data-tape-v={c.tapeV} aria-hidden="true"></span>
							<span class="tape tape-tr" data-tape-v={(c.tapeV + 1) % 6} aria-hidden="true"></span>
							<span class="tape tape-bl" data-tape-v={(c.tapeV + 2) % 6} aria-hidden="true"></span>
							<span class="tape tape-br" data-tape-v={(c.tapeV + 3) % 6} aria-hidden="true"></span>
							<div class="photo-inner">
								<span class="photo-scuff" aria-hidden="true"></span>
								<Image
									src={img.src}
									alt=""
									width={img.width}
									height={img.height}
									class="vintage-thumb w-full h-auto object-cover transition-transform duration-500 ease-out group-hover:scale-[1.02]"
									loading={c.loading}
									decoding="async"
								/>
							</div>
						</div>
					</a>
				); })}
			</div>
		) : (
			<div class="nostalgia-empty rounded-2xl p-12 sm:p-16 text-center max-w-xl mx-auto">
				<p class="font-cormorant text-[var(--nostalgia-sepia)] text-lg leading-relaxed">
					No photos yet. Add JPG files to <code class="rounded bg-[var(--nostalgia-border)]/60 px-2 py-0.5 text-[var(--nostalgia-ink)] font-outfit text-sm">public/gallery</code> and rebuild.
				</p>
			</div>
		)}
		<footer class="text-center py-8 sm:py-12">
			<p class="font-outfit text-xs sm:text-sm text-[var(--nostalgia-sepia)]/70 tracking-widest uppercase">
				Fuzhou, China · Early 2000s
			</p>
		</footer>
	</div>
</main>

	<!-- PhotoSwipe root -->
<div class="pswp" id="pswp-root" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="pswp__bg"></div>
	<div class="pswp__scroll-wrap">
		<div class="pswp__container">
			<div class="pswp__item"></div>
			<div class="pswp__item"></div>
			<div class="pswp__item"></div>
		</div>
		<div class="pswp__ui pswp__ui--hidden">
			<div class="pswp__top-bar">
				<div class="pswp__counter"></div>
				<button class="pswp__button pswp__button--close" title="Close"></button>
				<button class="pswp__button pswp__button--share" title="Share"></button>
				<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
				<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
				<div class="pswp__preloader">
					<div class="pswp__preloader__icn">
						<div class="pswp__preloader__cut">
							<div class="pswp__preloader__donut"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
				<div class="pswp__share-toolbar"></div>
			</div>
			<button class="pswp__button pswp__button--arrow--left" title="Previous"></button>
			<button class="pswp__button pswp__button--arrow--right" title="Next"></button>
			<div class="pswp__caption">
				<div class="pswp__caption__center"></div>
			</div>
		</div>
	</div>
</div>
</Layout>

<style is:global>
	.nostalgia-header {
		background: var(--nostalgia-cream);
		position: relative;
		z-index: 0;
	}

	.nostalgia-divider {
		width: 48px;
		height: 2px;
		background: linear-gradient(90deg, transparent, var(--nostalgia-accent), transparent);
		opacity: 0.7;
	}

	/* Concrete wall: sharp image texture only, no softening overlays */
	.concrete-wall {
		--concrete-base: #45403a;
		--concrete-dark: #3a3631;
		--concrete-light: #524c45;
		--concrete-mid: #4c4740;
		background-color: var(--concrete-base);
		position: relative;
		border-radius: 12px;
		overflow: hidden;
		/* Single layer: texture at native resolution so it stays sharp (no upscale blur) */
		background-image: url("/textures/concrete-wall.png");
		background-size: auto;
		background-position: 0 0;
		background-repeat: repeat;
		image-rendering: -webkit-optimize-contrast;
		image-rendering: crisp-edges;
	}
	.concrete-wall::before {
		content: "";
		position: absolute;
		inset: 0;
		pointer-events: none;
		/* Light dark tint only – keeps cracks and grain sharp */
		background: linear-gradient(
			180deg,
			rgba(28, 25, 22, 0.22) 0%,
			rgba(28, 25, 22, 0.15) 50%,
			rgba(32, 29, 26, 0.18) 100%
		);
	}
	.concrete-wall::after {
		content: "";
		position: absolute;
		inset: 0;
		pointer-events: none;
		/* Very subtle weathering only */
		background:
			linear-gradient(108deg, transparent 0%, rgba(0,0,0,0.03) 42%, transparent 48%),
			radial-gradient(ellipse 70% 30% at 25% 88%, rgba(0,0,0,0.05), transparent 55%);
	}
	.concrete-wall .nostalgia-gallery {
		position: relative;
		z-index: 1;
	}

	/* Physical photo on wall: paper border, shadow, slight rotation. overflow-visible so tape can extend onto wall */
	.nostalgia-card.photo-on-wall {
		position: relative;
		background: transparent;
		border: none;
		padding: 0;
		overflow: visible;
		box-shadow:
			0 4px 12px rgba(0, 0, 0, 0.25),
			0 1px 3px rgba(0, 0, 0, 0.2);
	}
	.gallery-item:nth-child(5n+1) .photo-on-wall { transform: rotate(-1.5deg); }
	.gallery-item:nth-child(5n+2) .photo-on-wall { transform: rotate(1.2deg); }
	.gallery-item:nth-child(5n+3) .photo-on-wall { transform: rotate(-0.8deg); }
	.gallery-item:nth-child(5n+4) .photo-on-wall { transform: rotate(1.4deg); }
	.gallery-item:nth-child(5n+5) .photo-on-wall { transform: rotate(-1.1deg); }
	.gallery-item:hover .photo-on-wall {
		transform: rotate(0deg) translateY(-2px);
		box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35), 0 4px 12px rgba(0, 0, 0, 0.25);
	}

	/* Tape: realistic translucent strips with center fold, randomized per photo */
	.tape {
		position: absolute;
		z-index: 2;
		pointer-events: none;
		background: linear-gradient(
			180deg,
			rgba(255, 250, 230, 0.75) 0%,
			rgba(245, 238, 210, 0.6) 45%,
			rgba(235, 225, 195, 0.55) 50%,
			rgba(245, 238, 210, 0.6) 55%,
			rgba(255, 250, 230, 0.75) 100%
		);
		box-shadow:
			0 0 0 1px rgba(200, 190, 160, 0.4),
			inset 0 1px 0 rgba(255,255,255,0.3),
			1px 2px 4px rgba(0,0,0,0.15);
		border-radius: 0;
	}
	/* Tape count: 1 = top edge only (tl or tr), 2 = top two or diagonal, 3 = one corner missing, 4 = all */
	.photo-on-wall[data-tapes="1"] .tape-bl,
	.photo-on-wall[data-tapes="1"] .tape-br { display: none; }
	.photo-on-wall[data-tapes="1"][data-tape-1="tr"] .tape-tl { display: none; }
	.photo-on-wall[data-tapes="1"][data-tape-1="tl"] .tape-tr { display: none; }
	.photo-on-wall[data-tapes="2"][data-tapes-2="top"] .tape-bl,
	.photo-on-wall[data-tapes="2"][data-tapes-2="top"] .tape-br { display: none; }
	.photo-on-wall[data-tapes="2"][data-tapes-2="diag-tlbr"] .tape-tr,
	.photo-on-wall[data-tapes="2"][data-tapes-2="diag-tlbr"] .tape-bl { display: none; }
	.photo-on-wall[data-tapes="2"][data-tapes-2="diag-trbl"] .tape-tl,
	.photo-on-wall[data-tapes="2"][data-tapes-2="diag-trbl"] .tape-br { display: none; }
	.photo-on-wall[data-tapes="3"][data-tapes-3="br"] .tape-br,
	.photo-on-wall[data-tapes="3"][data-tapes-3="bl"] .tape-bl,
	.photo-on-wall[data-tapes="3"][data-tapes-3="tr"] .tape-tr,
	.photo-on-wall[data-tapes="3"][data-tapes-3="tl"] .tape-tl { display: none; }

	/* More random orientations: 6 variants per corner, wider angle range */
	.tape-tl[data-tape-v="0"] { top: -10px; left: -6px; width: 46px; height: 14px; transform: rotate(-28deg); }
	.tape-tl[data-tape-v="1"] { top: -12px; left: -8px; width: 44px; height: 15px; transform: rotate(-44deg); }
	.tape-tl[data-tape-v="2"] { top: -9px; left: -5px; width: 48px; height: 14px; transform: rotate(-35deg); }
	.tape-tl[data-tape-v="3"] { top: -11px; left: -7px; width: 45px; height: 15px; transform: rotate(-52deg); }
	.tape-tl[data-tape-v="4"] { top: -10px; left: -6px; width: 47px; height: 14px; transform: rotate(-31deg); }
	.tape-tl[data-tape-v="5"] { top: -12px; left: -7px; width: 43px; height: 16px; transform: rotate(-39deg); }
	.tape-tr[data-tape-v="0"] { top: -10px; right: -6px; left: auto; width: 46px; height: 14px; transform: rotate(28deg); }
	.tape-tr[data-tape-v="1"] { top: -12px; right: -8px; left: auto; width: 44px; height: 15px; transform: rotate(44deg); }
	.tape-tr[data-tape-v="2"] { top: -9px; right: -5px; left: auto; width: 48px; height: 14px; transform: rotate(35deg); }
	.tape-tr[data-tape-v="3"] { top: -11px; right: -7px; left: auto; width: 45px; height: 15px; transform: rotate(52deg); }
	.tape-tr[data-tape-v="4"] { top: -10px; right: -6px; left: auto; width: 47px; height: 14px; transform: rotate(31deg); }
	.tape-tr[data-tape-v="5"] { top: -12px; right: -7px; left: auto; width: 43px; height: 16px; transform: rotate(39deg); }
	.tape-bl[data-tape-v="0"] { bottom: -10px; left: -6px; width: 46px; height: 14px; transform: rotate(28deg); }
	.tape-bl[data-tape-v="1"] { bottom: -12px; left: -8px; width: 44px; height: 15px; transform: rotate(44deg); }
	.tape-bl[data-tape-v="2"] { bottom: -9px; left: -5px; width: 48px; height: 14px; transform: rotate(35deg); }
	.tape-bl[data-tape-v="3"] { bottom: -11px; left: -7px; width: 45px; height: 15px; transform: rotate(52deg); }
	.tape-bl[data-tape-v="4"] { bottom: -10px; left: -6px; width: 47px; height: 14px; transform: rotate(31deg); }
	.tape-bl[data-tape-v="5"] { bottom: -12px; left: -7px; width: 43px; height: 16px; transform: rotate(39deg); }
	.tape-br[data-tape-v="0"] { bottom: -10px; right: -6px; left: auto; width: 46px; height: 14px; transform: rotate(-28deg); }
	.tape-br[data-tape-v="1"] { bottom: -12px; right: -8px; left: auto; width: 44px; height: 15px; transform: rotate(-44deg); }
	.tape-br[data-tape-v="2"] { bottom: -9px; right: -5px; left: auto; width: 48px; height: 14px; transform: rotate(-35deg); }
	.tape-br[data-tape-v="3"] { bottom: -11px; right: -7px; left: auto; width: 45px; height: 15px; transform: rotate(-52deg); }
	.tape-br[data-tape-v="4"] { bottom: -10px; right: -6px; left: auto; width: 47px; height: 14px; transform: rotate(-31deg); }
	.tape-br[data-tape-v="5"] { bottom: -12px; right: -7px; left: auto; width: 43px; height: 16px; transform: rotate(-39deg); }

	/* Photo paper: aged, yellowed border + wear */
	.photo-inner {
		position: relative;
		padding: 12px 12px 18px 12px;
		border-radius: 1px;
		overflow: hidden;
		background: linear-gradient(
			145deg,
			#e8e2d8 0%,
			#ebe5da 15%,
			#e2dcd0 40%,
			#ddd6c8 70%,
			#d8d0c0 100%
		);
		box-shadow:
			inset 0 0 0 1px rgba(180, 170, 150, 0.4),
			inset 0 1px 0 rgba(255,255,255,0.2);
	}
	.photo-on-wall[data-wear="0"] .photo-inner { filter: brightness(0.98); }
	.photo-on-wall[data-wear="1"] .photo-inner { filter: brightness(0.95); box-shadow: inset 0 0 0 1px rgba(160,150,130,0.5), inset 0 1px 0 rgba(255,255,255,0.15); }
	.photo-on-wall[data-wear="2"] .photo-inner { filter: brightness(0.93); background: linear-gradient(160deg, #e0d9ce 0%, #d9d1c4 50%, #d2c9ba 100%); }
	.photo-on-wall[data-wear="3"] .photo-inner { filter: brightness(0.92); background: linear-gradient(150deg, #ddd5c8 0%, #d4cbbe 100%); box-shadow: inset 0 0 0 1px rgba(140,130,115,0.5); }
	.photo-on-wall[data-wear="4"] .photo-inner { filter: brightness(0.9); background: linear-gradient(155deg, #d6cec0 0%, #cdc4b5 100%); }
	/* Subtle scuff / age overlay on the print */
	.photo-scuff {
		position: absolute;
		inset: 0;
		pointer-events: none;
		z-index: 1;
		opacity: 0.06;
		background-image:
			radial-gradient(ellipse 15% 20% at 85% 15%, rgba(100,80,60,0.5), transparent),
			radial-gradient(ellipse 10% 15% at 10% 88%, rgba(80,70,50,0.4), transparent),
			radial-gradient(ellipse 25% 8% at 50% 5%, rgba(120,100,80,0.2), transparent);
	}
	.photo-inner img {
		display: block;
		border-radius: 1px;
		position: relative;
		z-index: 0;
	}
	/* Vintage look only on thumbnail; lightbox shows original (colorful & sharp) */
	.vintage-thumb {
		filter: sepia(0.28) contrast(0.96) saturate(0.88);
	}
	.group:hover .vintage-thumb {
		filter: sepia(0.14) contrast(1) saturate(0.95);
	}
	.group:hover .photo-on-wall {
		border-color: transparent;
	}

	.nostalgia-empty {
		border: 1px dashed var(--nostalgia-border);
		background: var(--nostalgia-paper);
	}

	.gallery.masonry-columns {
		column-count: 2;
		column-gap: 1.25rem;
	}
	@media (min-width: 640px) {
		.gallery.masonry-columns {
			column-gap: 1.5rem;
		}
	}
	@media (min-width: 768px) {
		.gallery.masonry-columns {
			column-count: 3;
			column-gap: 1.75rem;
		}
	}
	@media (min-width: 1024px) {
		.gallery.masonry-columns {
			column-count: 4;
			column-gap: 2rem;
		}
	}
	.gallery-item {
		display: block;
		overflow: visible;
	}

	/* PhotoSwipe lightbox: dark overlay to match theme */
	.pswp--custom .pswp__bg {
		background: rgba(28, 25, 22, 0.97);
	}
	.pswp--custom .pswp__button--close,
	.pswp--custom .pswp__button--arrow--left,
	.pswp--custom .pswp__button--arrow--right,
	.pswp--custom .pswp__button--zoom,
	.pswp--custom .pswp__button--fs {
		color: var(--nostalgia-ink);
	}
	.pswp--custom .pswp__counter {
		color: var(--nostalgia-sepia);
		font-family: "Outfit", sans-serif;
	}
</style>

<script>
	import PhotoSwipeLightbox from 'photoswipe/lightbox';

	const lightbox = new PhotoSwipeLightbox({
		gallery: '#gallery',
		children: 'a',
		pswpModule: () => import('photoswipe'),
		pswpOptions: {
			mainClass: 'pswp--custom',
		},
	});
	lightbox.init();
</script>
